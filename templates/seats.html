{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="/static/style.css">

<style>
  /* ===== Temel deÄŸiÅŸkenler ===== */
  :root{
    --bg:#2f353a; --card:#1e2327; --muted:#3b4248; --text:#e8edf2;
    --brand:#1f6b2d; --danger:#8a3a3a; --primary:#2563eb; --warn:#d4a100; --accent:#0ea5e9;
  }

  /* ===== Resetler / temel ===== */
  body{color:var(--text); background:var(--bg)}
  .coach{width:960px;max-width:96vw;margin:16px auto}
  .head{font-weight:700;margin-bottom:10px}

/* ===== Ä°statistik paneli ===== */
  .stats{
  display:grid;
  grid-template-columns: repeat(5, 1fr); /* her zaman 5 kolon */
  gap:10px;
  margin:12px auto;
  max-width:960px;
  }

  .stat{
  background:var(--card);
  border:1px solid var(--muted);
  border-radius:12px;
  padding:10px;
  display:flex; flex-direction:column; gap:4px;
  box-shadow:0 10px 20px rgba(0,0,0,.25);
  cursor:default;
  }
  .stat .k{opacity:.85; font-size:12px}
  .stat .v{font-weight:900; font-size:20px}

@media (max-width:720px){
  .stats{
    grid-auto-flow: column;
    grid-auto-columns: minmax(120px, 1fr); /* her kutu min 120px */
    grid-template-columns: unset;          /* auto-flow aktif */
    overflow-x: auto;
    padding-bottom: 4px;                    /* scroll iÃ§in boÅŸluk */
    -webkit-overflow-scrolling: touch;
  }
  .stats::-webkit-scrollbar{ display:none }
}
  /* ===== Saat kutusu ===== */
  .clock-tile{
  position:relative;           /* sticky yerine normal akÄ±ÅŸ */
  bottom:auto; left:auto; right:auto;
  z-index:1100;
  display:flex; align-items:center; gap:12px; padding:10px 14px;
  background:var(--card); border:1px solid var(--muted); border-radius:12px;
  box-shadow:0 12px 28px rgba(0,0,0,.35); font-weight:700;
  margin:8px 0 16px;           /* Ã¼st-alt boÅŸluk */
  }
  .clock-actions{display:flex; align-items:center; gap:12px; flex-wrap:nowrap;}
  .clock-actions form{display:inline-flex; margin:0}
  .clock-right{margin-left:auto; text-align:right}
  .clock-tile .time{font-size:24px; letter-spacing:1px; font-variant-numeric:tabular-nums}
  .clock-tile .date{font-size:13px; opacity:.85}

  /* ===== Koltuk Ä±zgarasÄ± ===== */
  .deck{
  position:relative;
  display:grid; grid-template-columns:70px 70px 70px 70px; grid-auto-rows:70px;
  gap:24px; justify-content:center; margin-top:24px;   /* â†‘ boÅŸluÄŸu artÄ±r */
  }
  .cell{display:flex; flex-direction:column; align-items:center; justify-content:flex-start}
  .seat{
    position:relative; width:56px; height:56px; border-radius:14px;
    background:#1f6b2d; color:#fff; display:flex; align-items:center; justify-content:center;
    font-weight:800; cursor:pointer; box-shadow:0 8px 22px rgba(0,0,0,.35);
    user-select:none;
  }
  .seat:hover{filter:brightness(1.08)}
  .seat.selected{outline:3px solid #9ad1ff}
  .seat.isAssigned{filter:saturate(1)}
  .label{font-size:11px; color:#e6d48a; margin-top:4px; min-height:14px}

  .seat.multi-picked{
    outline: 3px dashed #7aa2ff;
    box-shadow: 0 0 0 3px rgba(122,162,255,.15) inset;
  }

  .corr{
    grid-column:2; grid-row:1/15; width:56px; border-radius:12px;
    background:#8a2b2b; display:flex; align-items:center; justify-content:center;
    color:#fff; font-weight:900; writing-mode:vertical-rl; text-orientation:mixed; letter-spacing:4px;
  }
  .door{
    grid-column:3/5; grid-row:8; height:28px; border-radius:10px;
    background:#7d602b; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:900;
  }

/* Servis rozeti (sol Ã¼st) */
.svc-badge{
  position:absolute; left:-6px; top:-6px;
  background:var(--accent); color:#fff;
  font-size:12px; border-radius:999px; padding:2px 6px; display:none;
}
.seat.has-service .svc-badge{ display:flex; }

/* Bagaj rozeti (saÄŸ Ã¼st): ðŸ§³ + sayÄ± */
.bag-badge{
  position:absolute; right:-6px; top:-6px;
  background:var(--primary); color:#fff;
  font-size:11px; font-weight:800; border-radius:9999px;
  padding:2px 6px; display:none; align-items:center; gap:4px;
  box-shadow:0 6px 14px rgba(0,0,0,.35);
}
.seat.has-bag .bag-badge{ display:inline-flex; }

  /* UyarÄ± animasyonu */
  @keyframes blinkWarn{
    0%,100%{box-shadow:0 0 0 0 rgba(212,161,0,.00); filter:brightness(1)}
    50%{box-shadow:0 0 0 8px rgba(212,161,0,.35); filter:brightness(1.1)}
  }
  .seat.blink-yellow{animation:blinkWarn 1s linear infinite; outline:3px solid var(--warn)}

  /* ===== Tek koltuk formu ===== */
  #seatForm{
    display:none; position:fixed; left:0; top:0;
    background:var(--card); color:#fff; border:1px solid var(--muted); border-radius:14px;
    padding:14px; width:420px; max-width:96vw; box-shadow:0 20px 40px rgba(0,0,0,.45);
    z-index:1700;
  }
  #seatForm .row{margin:8px 0; display:flex; gap:12px; align-items:center; flex-wrap:wrap}

  /* Butonlar & inputlar */
  .btn{background:var(--brand); color:#fff; border:none; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer}
  .btn.secondary{background:#444}
  .btn.danger{background:var(--danger)}
  .btn.primary{background:var(--primary)}
  .btn.warn{background:var(--warn); color:#242424}
  select, input[type="number"], input[type="text"], textarea{
    background:#0f1215; color:#fff; border:1px solid var(--muted); border-radius:10px; padding:6px 8px;
  }

  /* ===== UyarÄ± barlarÄ± ===== */
  .alertbar{
    max-width:960px; margin:16px auto; padding:12px;
    border:1px solid var(--muted); border-radius:14px; background:var(--card);
    display:flex; align-items:flex-end; gap:12px; flex-wrap:wrap;
    box-shadow:0 12px 24px rgba(0,0,0,.35);
  }
  .alertbar .field{display:flex; flex-direction:column; gap:6px; min-width:180px}
  .alertbar .spacer{flex:1}
  .muted{opacity:.8; font-size:13px}

  /* --- Next Stop (ns) kutusu --- */
  .nsbox{
    max-width:960px; margin:16px auto; padding:12px;
    border:1px solid var(--muted); border-radius:14px; background:var(--card);
    box-shadow:0 12px 24px rgba(0,0,0,.35);
  }
  .ns-row{
    display:grid; grid-template-columns: 1fr 120px 120px auto auto 1fr;
    gap:12px; align-items:end;
  }
  .ns-field{display:flex; flex-direction:column; gap:6px}
  .ns-toggle{display:flex; align-items:center; gap:8px; padding-top:6px}
  .ns-w120{max-width:120px}
  .ns-status{justify-self:end; opacity:.85; font-size:13px}

  /* Alt satÄ±r (koordinat) */
  .ns-sub{margin-top:10px}
  .ns-sub-inner{
    display:grid; grid-template-columns: 1fr 160px 160px auto;
    gap:12px; align-items:end;
  }
  .ns-col label{display:flex; flex-direction:column; gap:6px}
  .ns-w160{max-width:160px}

  /* Mobil dar ekran */
  @media (max-width:720px){
    .stats{grid-template-columns:repeat(2,1fr)}
    .ns-row{grid-template-columns: 1fr 1fr; align-items:end}
    .ns-status{grid-column:1/-1; justify-self:start; margin-top:4px}
    .ns-sub-inner{grid-template-columns: 1fr 1fr}
    .clock-actions{overflow-x:auto; -webkit-overflow-scrolling:touch}
    .clock-actions::-webkit-scrollbar{display:none}
  }

  /* Toast en Ã¼st */
  #toast{position:fixed; right:16px; top:16px; background:#000c; color:#fff; padding:8px 12px; border-radius:10px; display:none; z-index:3000}

  /* ===== FABâ€™ler ===== */
  .fab{
    position:fixed; height:56px; min-width:56px; padding:0 16px; border-radius:999px;
    border:1px solid var(--muted); background:var(--primary); color:#fff; font-weight:800;
    display:flex; align-items:center; gap:10px; box-shadow:0 14px 30px rgba(0,0,0,.45);
    cursor:grab; z-index:2200; user-select:none;
  }
  .fab.secondary{background:#16a34a}
  .fab .dot{width:8px; height:8px; border-radius:999px; background:#a3ff9f}
  .fab-col{display:flex; flex-direction:column; gap:12px}
  .fab.in-grid{
    position:relative; left:auto; right:auto; top:auto; bottom:auto;
    cursor:pointer; user-select:auto; z-index:2600;
  }

  /* Yuvarlak mini butonlar (saatte) */
  .circle-btn{
    width:48px; height:48px; border-radius:50%; border:none; background:#222;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 4px 10px rgba(0,0,0,.5); cursor:pointer; transition:all .2s ease;
  }
  .circle-btn svg{width:24px; height:24px}
  .circle-btn.green{color:#22c55e}
  .circle-btn.red{color:#ef4444}
  .circle-btn:hover{filter:brightness(1.2)}

  /* ===== Modal katmanlarÄ± ===== */
  .backdrop{display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:2300}
  .panel{
    display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    background:var(--card); color:#fff; border:1px solid var(--muted); border-radius:14px;
    padding:14px; width:560px; max-width:96vw; box-shadow:0 22px 44px rgba(0,0,0,.5); z-index:2400;
  }
  .panel .row{display:flex; gap:8px; margin:8px 0; flex-wrap:wrap}

  /* Ayakta popover */
  #standingBackdrop{display:none; position:fixed; inset:0; background:transparent; z-index:2350}
  #standingPopover{
    display:none; position:fixed; z-index:2360; width:360px; max-width:min(94vw,420px);
    padding:12px; background:var(--card); color:var(--text);
    border:1px solid var(--muted); border-radius:12px; box-shadow:0 14px 30px rgba(0,0,0,.45);
  }
  #standingPopover .head{font-weight:800; margin-bottom:8px}
  #standingPopover .hint{opacity:.85; font-size:13px; margin-bottom:6px}
  #standingPopover .item{
    display:flex; align-items:center; gap:8px; padding:6px 0;
    border-bottom:1px dashed rgba(255,255,255,.08);
  }
  #standingPopover .item:last-child{border-bottom:none}
  #standingPopover .who{flex:1 1 auto; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  #standingPopover .actions{flex:0 0 auto; display:flex; gap:8px}
  #standingPopover .actions .btn{padding:6px 10px; font-size:12px; line-height:1.1}

  /* Koridor baÅŸÄ± hayali BOÅžALT */
  #btnGhostOffload{
    display:none; position:absolute; left:50%; transform:translateX(-50%); top:-56px;
    padding:10px 16px; border-radius:12px; background:#ef4444; color:#fff; font-weight:900;
    border:1px solid #7f1d1d; box-shadow:0 10px 20px rgba(0,0,0,.35); z-index:1200;
  }

  /* ===== Geofence bar katmanlarÄ± ===== */
  #alertBar{position:relative; z-index:50}
  #alertStop{position:relative; z-index:60}
  #coordPanel{position:relative; z-index:40; margin-top:12px}
  #clockTile{z-index:30}

  .fab.secondary.in-grid { transform: translateY(-20px); }
  .panel{ z-index: 3000 !important; }
  #standingPopover{ z-index: 3000 !important; }
  .fab.in-grid { z-index: 1000 !important; }

/* SÄ±radaki durak rozeti */
.stop-badge {
  position:absolute;
  left:-6px; bottom:-6px;
  background:#d4a100; color:#242424;
  font-size:12px; border-radius:999px;
  padding:2px 6px;
  font-weight:700;
  display:none;
}
.seat.has-stop .stop-badge { display:flex; }

  .speed-tile{
    display:flex; flex-direction:column; justify-content:center;
    align-items:center; gap:.2rem; width:110px; min-height:80px;
    border:2px solid rgba(255,255,255,.15); border-radius:10px;
    background:rgba(0,0,0,.25); backdrop-filter: blur(4px);
    padding:.4rem .6rem; margin:0 .6rem;
  }
  .speed-tile .sp-row{display:flex; align-items:baseline; gap:.35rem;}
  .speed-tile #spVal{font-size:2rem; font-weight:800; line-height:1;}
  .speed-tile .unit{opacity:.8; font-size:.9rem;}
  .speed-tile .sp-sub{font-size:.85rem; opacity:.85;}
  .speed-tile.limit-ok   {box-shadow:0 0 0 2px rgba(0,200,0,.35) inset;}
  .speed-tile.limit-warn {box-shadow:0 0 0 2px rgba(255,165,0,.45) inset;}
  .speed-tile.limit-bad  {box-shadow:0 0 0 2px rgba(255,0,0,.55) inset;}

  #ttsToggle{ margin-left:.6rem; font-size:1.2rem; line-height:1; padding:.4rem .6rem; }
  #ttsToggle.muted{ opacity:.5; text-decoration:line-through; }

/* ===== Saat paneli: hÄ±z/limit durum rengi (geniÅŸ Ã§erÃ§eve) ===== */
#clockTile{ transition: box-shadow .25s ease, border-color .25s ease; }
.clock-tile.limit-ok{
  box-shadow: 0 0 0 3px rgba(34,197,94,.35), 0 12px 28px rgba(34,197,94,.20);
  border-color: rgba(34,197,94,.55);
}
.clock-tile.limit-warn{
  box-shadow: 0 0 0 3px rgba(245,158,11,.45), 0 12px 28px rgba(245,158,11,.25);
  border-color: rgba(245,158,11,.65);
}
.clock-tile.limit-bad{
  box-shadow: 0 0 0 3px rgba(239,68,68,.55), 0 12px 28px rgba(239,68,68,.30);
  border-color: rgba(239,68,68,.75);
}

/* ===== Ä°statistik kutularÄ±: daha kompakt + animasyonlu halka ===== */
.stats{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* kÃ¼Ã§Ã¼ldÃ¼ */
  gap: 8px;
  margin: 10px auto;
  max-width: 960px;
}

/* Kart gÃ¶vdesi (kompakt) */
.stat{
  position: relative;
  isolation: isolate;
  min-width: 0;
  background: var(--card);
  border: 1px solid var(--muted);
  border-radius: 10px;
  padding: 8px;                               /* kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */
  display: flex; flex-direction: column; gap: 4px;
  box-shadow: 0 8px 16px rgba(0,0,0,.22);
}

/* YazÄ± boyutlarÄ± (kompakt) */
.stat .k{ opacity:.85; font-size: 11px; }
.stat .v{ font-weight: 900; font-size: 18px; }

/* DÄ±ÅŸtaki hareketli halka */
.stat::before{
  content:"";
  position:absolute; inset:-1px;              /* daha ince dÄ±ÅŸ halka */
  border-radius:10px;
  background-size: 240% 240%;
  animation: ringmove 4s linear infinite;     /* biraz daha yavaÅŸ */
  z-index:0;
}
/* Ä°Ã§ dolgu: ortayÄ± kapatÄ±r */
.stat::after{
  content:"";
  position:absolute; inset:2px;
  border-radius:8px;
  background: var(--card);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
  z-index:1;
}
/* Ä°Ã§erik Ã¼stte kalsÄ±n */
.stat > *{ position:relative; z-index:2; }

/* Mobilde yatay kaydÄ±rma */
@media (max-width:720px){
  .stats{
    grid-auto-flow: column;
    grid-auto-columns: minmax(160px, 1fr);
    grid-template-columns: unset;
    overflow-x: auto;
    padding-bottom: 4px;
    -webkit-overflow-scrolling: touch;
  }
  .stats::-webkit-scrollbar{ display:none; }
}

/* Her kutunun rengi (halka) */
#tileTotal::before{
  background: linear-gradient(90deg,#3b82f6,#60a5fa,#3b82f6);
}
#tileEmpty::before{
  background: linear-gradient(90deg,#22c55e,#4ade80,#22c55e);
}
#tileOccupancy::before{
  background: linear-gradient(90deg,#f97316,#fb923c,#f97316);
}
#tileStanding::before{
  background: linear-gradient(90deg,#ef4444,#f87171,#ef4444);
}
#tilePayment::before{
  background: linear-gradient(90deg,#8b5cf6,#a78bfa,#8b5cf6);
}

/* Halka akÄ±ÅŸÄ± */
@keyframes ringmove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

/* Sadece uyarÄ±lara nabÄ±z */
.pulse{ animation: pulseGlow 1.8s ease-in-out infinite; }
@keyframes pulseGlow{ 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.06)} }

/* Namaz vakti vurgu renkleri */
.pr-accent{ color:#f59e0b; font-weight:800; }   /* o anki vakit adÄ± + saati */
.pr-left  { color:#60a5fa; font-weight:900; }   /* kalan sÃ¼re */
.pr-mini span.now b{ color:#f59e0b; text-shadow:0 0 8px rgba(245,158,11,.35); }

/* â‰¤10 dk kala kÄ±rmÄ±zÄ± yanÄ±p sÃ¶nme */
.pr-left.soon{ color:#ef4444; animation: pr-blink 1s infinite }
@keyframes pr-blink{ 0%,100%{opacity:1} 50%{opacity:.35} }

</style>

<!-- Ä°statistikler -->
<div class="coach" aria-label="OtobÃ¼s Koltuk PlanÄ±">
  <div class="head">
    Sefer: {{ trip['route'] }} â€” Plaka: {{ trip['plate'] }} â€”
    1. Kaptan: {{ trip['captain1'] or '-' }} â€” 2. Kaptan: {{ trip['captain2'] or '-' }} â€”
    Muavin: {{ trip['attendant'] or '-' }}
  </div>

  <div class="stats" aria-label="Ä°statistik KutularÄ±">
    <div class="stat" id="tileTotal" aria-live="polite">
      <div class="k">Toplam Yolcu</div>
      <div class="v" id="st_totalPax">0</div>
    </div>

    <div class="stat" id="tileEmpty" aria-live="polite">
      <div class="k">BoÅŸ Koltuk</div>
      <div class="v" id="st_empty">0</div>
    </div>

    <div class="stat" id="tileOccupancy" aria-live="polite">
      <div class="k">Doluluk OranÄ±</div>
      <div class="v" id="st_occupancy">0%</div>
    </div>

    <div class="stat" id="tileStanding"
         role="button" tabindex="0" title="Ayakta yolcularÄ± gÃ¶ster"
         aria-controls="standingPopover" aria-expanded="false">
      <div class="k">Ayakta Yolcu</div>
      <div class="v" id="st_standing">0</div>
    </div>

    <div class="stat" id="tilePayment" aria-live="polite">
      <div class="k">Ayakta Tahsilat</div>
      <div class="v" id="st_standingTL">â‚º0.00</div>
    </div>
  </div>
</div>

  <!-- Saat -->
  <div id="clockTile" class="clock-tile" aria-live="polite">
    <div class="clock-actions">

<!-- Namaz vakti (tek satÄ±r + kÃ¼Ã§Ã¼k liste) -->
<div id="prayerTile">
  <div class="pr-top">
    <span id="pr-line">Konum alÄ±nÄ±yorâ€¦</span>
  </div>
</div>
    <!-- Ana Sayfa -->
      <a href="{{ url_for('index') }}" class="circle-btn green" title="Ana Sayfa" aria-label="Ana Sayfa">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3l9 9h-3v9H6v-9H3z"/></svg>
      </a>

      <!-- Seferi SonlandÄ±r -->
      <form method="post" action="{{ url_for('end_trip') }}"
            onsubmit="try{localStorage.removeItem(LSK);localStorage.removeItem(LSK+':items');localStorage.removeItem(LSK+':boards');standingItems.length=0;standingCount=0;standingRevenue=0;persistStandingItems();persistStandingTotals();}catch(_){} return confirm('Sefer sonlandÄ±rÄ±lsÄ±n mÄ±?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit" class="circle-btn red" title="Seferi SonlandÄ±r" aria-label="Seferi SonlandÄ±r">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>
        </button>
      </form>
    </div>

     <!-- HÄ±z/Limit -->
    <div id="speedTile" class="speed-tile" aria-live="polite" title="AnlÄ±k hÄ±z / yol hÄ±zÄ±">
      <div class="sp-row">
    <span id="spVal">0</span><span class="unit">km/h</span>
     </div>
     <div class="sp-sub" id="spLimit">â€”</div>
   <!-- Ses (TTS) anahtarÄ± -->
    <button id="ttsToggle" class="circle-btn" type="button" title="Sesli uyarÄ±">
    ðŸ”Š
   </button>
  </div>

    <div class="clock-right">
      <div class="time" id="clockMain"></div>
      <div class="date" id="clockSub"></div>
    </div>
  </div>

  <!-- Koltuk Ä±zgarasÄ± -->
  <div class="deck" id="deck">
    <button id="btnGhostOffload" class="btn danger">BOÅžALT</button>
    <div class="corr">KORÄ°DOR</div>

    {% set seats_map = {
      1:[1,1],3:[1,3],4:[1,4], 5:[2,1],7:[2,3],8:[2,4],
      9:[3,1],11:[3,3],12:[3,4], 13:[4,1],15:[4,3],16:[4,4],
      17:[5,1],19:[5,3],20:[5,4], 21:[6,1],23:[6,3],24:[6,4],
      25:[7,1],27:[7,3],28:[7,4],
      29:[8,1],
      31:[9,1],33:[9,3],34:[9,4],
      35:[10,1],37:[10,3],38:[10,4],
      39:[11,1],41:[11,3],42:[11,4],
      43:[12,1],45:[12,3],46:[12,4],
      49:[13,3],50:[13,4],
      51:[14,1],52:[14,2],53:[14,3],54:[14,4]
    } %}

    {% for n, pos in seats_map.items() %}
   {% if n == 29 %}<div class="door">KAPI</div>{% endif %}
   <div class="cell" style="grid-row:{{ pos[0] }};grid-column:{{ pos[1] }};">
    <div
      class="seat"
      id="seat-{{ n }}"
      data-seat="{{ n }}"
      role="button"
      aria-label="Koltuk {{ n }}"
      onclick="handleSeatClick({{ n }})"
    >
{{ n }}
<span class="svc-badge" title="Servis">ðŸšŒ</span>

<span class="bag-badge" title="Bagaj">
  <span>ðŸ§³</span><span class="bag-count">0</span>
</span>

<span class="stop-badge" title="Bu durakta inecek">ðŸ””</span>
</div>
<div class="label" id="label-{{ n }}"></div>
</div>
{% endfor %}

    <!-- 43 (12,1) ile 51 (14,1) arasÄ±ndaki sabit FAB sÃ¼tunu -->
    <div class="cell" style="grid-row:13;grid-column:1;">
      <div class="fab-col" style="position:relative; top:-20px">
        <button id="fabBulkFixed" class="fab in-grid"><span class="dot"></span> Toplu GiriÅŸ</button>
        <button id="fabCashFixed" class="fab secondary in-grid"><span class="dot"></span> HÄ±zlÄ± Tahsilat</button>
      </div>
    </div>
  </div>

<!-- SÄ±radaki Durak -->
<section class="nsbox">
  <div class="ns-row">
    <label class="ns-field">
      <span>SÄ±radaki Durak</span>
      <select id="alertStop" aria-label="SÄ±radaki Durak">
        <option value="">â€”</option>
      </select>
    </label>

    <label class="ns-field ns-w120">
      <span>EÅŸik (km)</span>
      <input type="number" id="alertRadius" step="0.1" min="0.1" value="3">
    </label>

    <label class="ns-field ns-w120">
      <span>Ses</span>
      <label class="ns-toggle">
        <input type="checkbox" id="soundToggle" checked> AÃ§Ä±k
      </label>
    </label>

    <button class="btn primary" id="btnGeoWatch">Konumu Ä°zle: KAPALI</button>
    <button class="btn warn" id="btnTriggerNow">Åžimdi Uyar</button>
    <button class="btn danger" id="btnOffloadNow" title="SeÃ§ili durakta inecekleri tek tÄ±kla indir">Ä°necekleri indir</button>

    <!-- âœ… Yeni eklenen kÄ±sÄ±m -->
    <label class="ns-field ns-w120">
      <span>Oto Ä°lerle</span>
      <label class="ns-toggle">
        <input type="checkbox" id="autoAdvanceToggle" checked> AÃ§Ä±k
      </label>
    </label>
    <!-- âœ… BitiÅŸ -->

    <div class="ns-status" id="geoHint">Durak seÃ§.</div>
  </div>

  <!-- Koordinat Ã–zet / DÃ¼zenleme -->
  <div id="coordPanel" class="ns-sub" style="display:none">
    <div class="ns-sub-inner">
      <div class="ns-col">
        <label>SeÃ§ili Durak
          <input type="text" id="coordStopName" readonly>
        </label>
      </div>
      <div class="ns-col ns-w160">
        <label>Lat
          <input type="number" id="coordLat" step="0.000001" placeholder="37.xxxxxx">
        </label>
      </div>
      <div class="ns-col ns-w160">
        <label>Lng
          <input type="number" id="coordLng" step="0.000001" placeholder="29.xxxxxx">
        </label>
      </div>
      <div class="ns-col">
        <button class="btn" id="btnSaveCoord">KoordinatÄ± Kaydet</button>
        <div class="muted">KayÄ±t tablosu: <code>route_stop_coords</code></div>
      </div>
    </div>
  </div>
</section>

  <!-- YaklaÅŸma Paneli -->
  <div id="approachBackdrop" class="backdrop" aria-hidden="true"></div>
  <div id="approachPanel" class="panel" role="dialog" aria-modal="true" aria-labelledby="approachTitle" aria-describedby="approachInfo">
    <h3 id="approachTitle" style="margin:0 0 10px 0">Durak YaklaÅŸÄ±yor</h3>
    <div id="approachInfo" class="hint">â€”</div>
    <div id="approachList" class="list" style="max-height:240px; overflow:auto; margin-top:8px"></div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn danger" id="approachOffload">Toplu Ä°ndir</button>
      <button class="btn secondary" id="approachClose">Kapat</button>
      <button class="btn secondary" id="approachSnooze">Ertele (5 dk)</button>
    </div>
  </div>

  <!-- Toplu GiriÅŸ Panel -->
  <div id="bulkBackdrop" class="backdrop" aria-hidden="true"></div>
  <div id="bulkPanel" class="panel" role="dialog" aria-modal="true" aria-labelledby="bulkTitle">
    <h3 id="bulkTitle" style="margin:0 0 10px 0">Toplu GiriÅŸ</h3>
    <div class="row">
      <label style="flex:1">Nereden
        <select id="bulkFrom"><option value="">â€”</option></select>
      </label>
      <label style="flex:1">Nereye
        <select id="bulkTo"><option value="">â€”</option></select>
      </label>
      <label>Adet
        <input type="number" id="bulkCount" min="1" value="1" style="width:100px">
      </label>
    </div>
    <div class="row">
      <label><input type="radio" name="bulkTicket" value="biletsiz" checked> Biletsiz</label>
      <label><input type="radio" name="bulkTicket" value="biletli"> Biletli</label>
      <label style="margin-left:auto; display:flex; align-items:center; gap:6px"><input type="checkbox" id="multiPick"> Ã‡oklu seÃ§im</label>
      <label style="margin-left:auto"><input type="checkbox" id="bulkService"> Servis</label>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button type="button" class="btn secondary" id="bulkClose">Kapat</button>
      <button type="button" class="btn primary" id="bulkSave">Kaydet</button>
    </div>
    <div class="muted" style="margin-top:6px">
      Ã‡oklu seÃ§im: iÅŸaretle â†’ paneli kapat â†’ koltuklara dokunarak seÃ§ â†’ tekrar aÃ§Ä±p Kaydet.<br>
      Ã‡oklu seÃ§im kapalÄ±ysa: seÃ§im yoksa boÅŸ koltuklardan rastgele doldurur.
    </div>
  </div>

  <!-- HÄ±zlÄ± Tahsilat Panel -->
  <div id="cashBackdrop" class="backdrop" aria-hidden="true"></div>
  <div id="cashPanel" class="panel" role="dialog" aria-modal="true" aria-labelledby="cashTitle">
    <h3 id="cashTitle" style="margin:0 0 10px 0">HÄ±zlÄ± Tahsilat (Ayakta)</h3>
    <div class="row">
      <label>Adet <input type="number" id="cashCount" min="1" value="1" style="width:100px"></label>
      <label>Tutar (â‚º/kiÅŸi) <input type="number" id="cashPrice" min="0" step="0.01" value="0" style="width:140px"></label>
      <label>Ã–deme
        <select id="cashPay">
          <option value="nakit">Nakit</option><option value="iban">IBAN</option><option value="pos">POS</option><option value="online">Online</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label>Nereden <select id="cashFrom"><option value="">â€”</option></select></label>
      <label>Nereye <select id="cashTo"><option value="">â€”</option></select></label>
    </div>
    <div class="row">
      <label style="flex:1">Not <input type="text" id="cashNote" placeholder="KÄ±sa not..."></label>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn secondary" id="cashClose">Kapat</button>
      <button class="btn primary" id="cashSave">Ekle</button>
    </div>
    <div class="muted">Koltuk atamasÄ± yapmaz; ayakta yolcu ve tahsilat toplamÄ±nÄ± artÄ±rÄ±r.</div>
  </div>

<!-- Tek koltuk formu -->
<div id="seatForm" role="dialog" aria-modal="true">
  <h3 id="seatTitle">Koltuk</h3>

  <div class="row">
    <label>BiniÅŸ Yeri:
      <select id="pickup"><option value="">â€”</option></select>
    </label>
  </div>

  <div class="row">
    <label>Ä°niÅŸ Yeri:
      <select id="dropoff"><option value="">â€”</option></select>
    </label>
  </div>

  <div class="row">
    <label>Bilet:</label>
    <label><input type="radio" name="ticket" value="biletli"> Biletli</label>
    <label><input type="radio" name="ticket" value="biletsiz"> Biletsiz</label>
    <label><input type="radio" name="ticket" value="ucretsiz"> Ãœcretsiz</label>
  </div>

  <div class="row">
    <label>Ã–deme:</label>
    <label><input type="radio" name="pay" value="nakit"> Nakit</label>
    <label><input type="radio" name="pay" value="iban"> IBAN</label>
    <label><input type="radio" name="pay" value="online"> Online</label>
    <label><input type="radio" name="pay" value="pos"> POS</label>
    <label><input type="radio" name="pay" value="ucretsiz"> Ãœcretsiz</label>
  </div>

  <div class="row">
    <label>Tutar (â‚º):
      <input type="number" id="price" value="0.00">
    </label>
  </div>

  <div class="row">
    <label>Cinsiyet:</label>
    <label><input type="radio" name="gender" value="bay"> Bay</label>
    <label><input type="radio" name="gender" value="bayan"> Bayan</label>
    <label><input type="radio" name="gender" value="bos"> BoÅŸ</label>
  </div>

  <div class="row"><label><input type="checkbox" id="adjacent"> Yan yana istisna</label></div>
  <div class="row"><label><input type="checkbox" id="service"> Servis kullanacak</label></div>
  <div class="row"><label style="flex:1">Servis notu:
    <input type="text" id="service_note" placeholder="Mahalle / konum (opsiyonel)">
  </label></div>

<!-- ðŸ”¹ BAGAJ BUTONLARI -->
<div class="row" style="justify-content:flex-start; gap:8px;">
  <!-- Bagaj Ekle -->
  <button class="btn primary" id="btnBagAdd" type="button"
    onclick="
      const seat = document.getElementById('seatTitle').textContent.replace('Koltuk ', '').trim();
      const drop = document.getElementById('dropoff')?.value || '';
      const next = window.location.pathname;  // Koltuk ekranÄ±na geri dÃ¶n
      const trip = window.BAG_TRIP || '{{ (trip['route'] ~ '|' ~ trip['plate'])|replace(' ', '_') }}';

      const url = `/bags/capture?trip_code=${encodeURIComponent(trip)}`
                + `&seat=${encodeURIComponent(seat)}`
                + `&to_stop=${encodeURIComponent(drop)}`
                + `&next=${encodeURIComponent(next)}`;

      window.location.href = url;
    ">
    ðŸ§³ Bagaj Ekle
  </button>

  <!-- Bagaj GÃ¶r -->
  <button class="btn secondary" id="btnBagView" type="button"
    onclick="
      const seat = document.getElementById('seatTitle').textContent.replace('Koltuk ', '').trim();
      const next = window.location.pathname;
      const trip = window.BAG_TRIP || '{{ (trip['route'] ~ '|' ~ trip['plate'])|replace(' ', '_') }}';

      const url = `/bags?trip=${encodeURIComponent(trip)}`
                + `&seat=${encodeURIComponent(seat)}`
                + `&next=${encodeURIComponent(next)}`;

      window.location.href = url;
    ">
    ðŸ“¸ Bagaj GÃ¶r
  </button>
</div>

<!-- ðŸ”¹ ALT BUTONLAR -->
<div class="row" style="justify-content:flex-end; gap:8px;">
  <button class="btn" onclick="saveSeat()">Kaydet</button>
  <button class="btn danger" onclick="offloadSeat()">Ä°niÅŸ (BoÅŸalt)</button>
  <button class="btn secondary" onclick="closeForm()">Kapat (ESC)</button>
</div>

  <!-- Ayakta Yolcu popover -->
  <div id="standingBackdrop" onclick="closeStandingPopover()" aria-hidden="true"></div>
  <div id="standingPopover" role="dialog" aria-modal="true" aria-labelledby="standingTitle">
    <div class="head" id="standingTitle">Ayakta Yolcular</div>
    <div class="hint" id="standingSummary">â€”</div>
    <div id="standingList"></div>
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px">
      <button class="btn danger" id="standingBulkOff" style="display:none">Toplu Ä°ndir</button>
      <button class="btn secondary" id="standingClose" onclick="closeStandingPopover()">Kapat</button>
    </div>
  </div>
</div>

<div id="toast" role="status" aria-live="polite"></div>

<script>
/* ===== Globals ===== */
const standingItems = []; // [{id, from, to, count, price, payment, note, ts}]

async function loadStandingItems(){
  try{
    const j = await safeJsonFetch('/api/standing/list');
    if(j?.ok && Array.isArray(j.items)){
      standingItems.splice(0, standingItems.length, ...j.items);
      return;
    }
  }catch(_) {}
  try{
    const arr = JSON.parse(localStorage.getItem(LSK+':items') || '[]');
    if(Array.isArray(arr)) standingItems.push(...arr);
  }catch(_) {}
}
function persistStandingItems(){ try{ localStorage.setItem(LSK+':items', JSON.stringify(standingItems)); }catch(_){} }

const TRIP_ID = "{{ (trip['route'] ~ '|' ~ trip['plate'])|replace(' ', '_') }}";
const LSK = "standingTotals:" + TRIP_ID;
const csrf = "{{ csrf_token }}";

const assigned     = {{ assigned | tojson | safe }};
const stopsMap     = {{ stops_map | tojson | safe }};
const boardsMap    = {{ boards_map or {} | tojson | safe }};
const genders      = {{ genders | tojson | safe }};
const serviceMap   = {{ service_map | tojson | safe }};
const service_notes = {{ service_notes | tojson | safe }};

let cachedStops = null, currentSeat=null, geoWatchId=null, lastAlertAt=0;
const ALERT_COOLDOWN_MS = 3*60*1000;
let pendingDrops = new Set(), snoozeUntil=0;
let standingCount=0, standingRevenue=0;

async function loadStandingTotals(){
  try{
    const j = await safeJsonFetch('/api/standing');
    if(j?.ok){ standingCount = Number(j.count||0); standingRevenue = Number(j.revenue||0); return; }
  }catch(_) {}
  try{
    const mem = JSON.parse(localStorage.getItem(LSK) || 'null');
    standingCount = Number(mem?.count || 0);
    standingRevenue = Number(mem?.revenue || 0);
  }catch(_){ standingCount = 0; standingRevenue = 0; }
}
function persistBoardsMapToLS(){ try{ localStorage.setItem(LSK + ':boards', JSON.stringify(boardsMap || {})); }catch(_){} }
function loadBoardsMapFromLS(){ try{ const obj = JSON.parse(localStorage.getItem(LSK + ':boards') || '{}'); if (obj && typeof obj === 'object') { Object.assign(boardsMap, obj); } } catch (_){} }
function persistStandingTotals(){ try{ localStorage.setItem(LSK, JSON.stringify({ count: standingCount, revenue: standingRevenue })); }catch(_){} }

let multiMode=false; const multiSelected=new Set();
let lastApproach = { stop:null, seats:[] };

/* ===== Helpers ===== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function toast(msg, ms=2000){ const t = $('#toast'); if(!t) return; t.textContent = msg; t.style.display = 'block'; setTimeout(()=> t.style.display='none', ms); }
const fmtTL = n => 'â‚º' + (Number(n||0).toFixed(2));
function parseMoney(v){ if (typeof v === 'number') return v; const s=(v||'').toString().replace(',','.'); const x=parseFloat(s); return isNaN(x)?0:x; }
function distKm(a,b){ const R=6371, toRad=d=>d*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng); const la1=toRad(a.lat), la2=toRad(b.lat); const h = Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }

async function safeJsonFetch(url,opt){ const r=await fetch(url,opt||{}); const ct=r.headers.get('content-type')||''; if(!ct.includes('application/json')){ await r.text(); throw new Error('JSON bekleniyordu'); } return r.json(); }
function sampleRandom(arr, k){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a.slice(0, Math.max(0, Math.min(k, a.length))); }
function computeStopCounts(){ const out={}; Object.values(stopsMap||{}).forEach(stop=>{ if(!stop) return; out[stop]=(out[stop]||0)+1; }); return out; }

// --- Emanet (parcels) global + loader + sayÄ±cÄ± ---
let parcelItems = [];   // [{to, count}]

async function loadParcelItems(){
  try{
    const j = await safeJsonFetch('/api/parcels?status=bekliyor');
    if (j?.ok && Array.isArray(j.items)){
      parcelItems = j.items.slice();
      return;
    }
  }catch(_){}
  parcelItems = [];
}

function computeParcelCountsByStop(){
  const out = {};
  (parcelItems || []).forEach(it=>{
    const raw = (it?.to || '').trim();
    if (!raw) return;
    const key = (findStopByName(raw)?.name || raw).trim(); // kanonikleÅŸtir
    const c   = Number(it?.count || 0);
    if (!c) return;
    out[key] = (out[key] || 0) + c;
  });
  return out;
}

/* === SÄ±radaki Durak select rozetleri === */
function refreshStopBadges(){
  const sel = $('#alertStop'); 
  if(!sel) return;

  const seatCounts  = computeStopCounts();
  const standCounts = computeStandingCountsByStop();
  const parcelCounts = computeParcelCountsByStop();  // yeni
  
  [...sel.options].forEach(opt=>{
    if(!opt.value){ 
      opt.textContent = 'â€”'; 
      return; 
    }

    const base = opt.dataset.label || opt.value;
    const sObj = findStopByName(base);
    const dot  = hasCoord(sObj) ? ' â€¢' : '';

    const seated = seatCounts[base]  
      ? ` (${seatCounts[base]} koltuk)` 
      : '';
    const stand  = standCounts[base] 
      ? ` + Ayakta ${standCounts[base]}` 
      : '';

    // ðŸ“¦ emanet sayacÄ± (toplam)
    const parcels = parcelCounts[base] ? ` ðŸ“¦ ${parcelCounts[base]}` : '';
    opt.textContent = base + dot + seated + stand + parcels;
  });
}

function computeStandingCountsByStop(){
  const out = {};
  (standingItems || []).forEach(it => {
    const raw = (it?.to || '').trim();
    if (!raw) return;
    const key = (findStopByName(raw)?.name || raw).trim(); // kanonikleÅŸtir
    const c = Number(it?.count || 0);
    if (!c) return;
    out[key] = (out[key] || 0) + c;
  });
  return out;
}

// ... diÄŸer kodlarÄ±nÄ±n arasÄ±na (mevcut yerindeki fonksiyonun yerine) yapÄ±ÅŸtÄ±r ...

function idsForStandingStop(stopName){
  const t = norm(stopName);
  return (standingItems || [])
    .filter(it => norm(it?.to || '') === t)
    .map(it => it?.id)
    .filter(Boolean);
}

async function offloadStandingForStop(stopName){
  const t = norm(stopName);
  let removed = 0;

  // 1) Sunucudan sil (to veya to_stop parametresiyle)
  try{
    await safeJsonFetch('/api/standing?to=' + encodeURIComponent(stopName), {
      method: 'DELETE',
      headers: { 'X-CSRF-Token': csrf }
    });
  }catch(e){
    // aÄŸ hatasÄ± olursa UI yine de gÃ¼ncellensin
  }

  // 2) Frontend listeden dÃ¼ÅŸ
  for (let i = standingItems.length - 1; i >= 0; i--){
    const it = standingItems[i];
    if (norm(it?.to || '') === t){
      removed += Number(it?.count || 0);
      standingItems.splice(i, 1);
    }
  }

  // 3) SayaÃ§/ekranlarÄ± gÃ¼ncelle
  if (removed > 0){
    standingCount = Math.max(0, standingCount - removed);
    persistStandingItems();
    persistStandingTotals();
    updateStats();
    refreshStopBadges();
  }
  return removed;
}

/* ======== Otomatik ilerleme yardÄ±mcÄ±larÄ± ======== */

// "alertStop" select'inde bir durak seÃ§ili mi?
function getSelectedStopName(){
  return ($('#alertStop')?.value || '').trim();
}

// cachedStops'ta (rota sÄ±rasÄ±ndaki) bir durak adÄ± iÃ§in index
function indexOfStopByName(name){
  if (!Array.isArray(cachedStops)) return -1;
  const t = norm(name);
  return cachedStops.findIndex(s => norm(s?.name) === t);
}

// Bu durakta inecek yolcu var mÄ±?
function hasPassengersFor(stopName){
  return seatsForStop(stopName).length > 0;
}

// Bu ad, rotadaki son durak mÄ±?
function isFinalStop(name){
  if (!Array.isArray(cachedStops) || !cachedStops.length) return false;
  const idx = indexOfStopByName(name);
  return idx >= 0 && idx === cachedStops.length - 1;
}

// Final durak iÃ§in iki aÅŸamalÄ± konuÅŸma
function speakFinalStopSequence(name){
  const cnt = seatsForStop(name).length;
  // 1) SÄ±radaki durak + yolcu sayÄ±sÄ±
  speak(`SÄ±radaki Durak ${name}. Bu durakta ${cnt} yolcu inecek.`);
  // 2) TeÅŸekkÃ¼r mesajÄ± (kÄ±sa gecikmeyle)
  setTimeout(()=>{
    speak('AlÃ¢Ã¢ AlaÅŸehir Ailesini Tercih ettiÄŸiniz iÃ§in teÅŸekkÃ¼r ederiz. Bir sonraki yolculukta buluÅŸmak dileÄŸiyle.');
  }, 1800);
}

// Sonraki duraÄŸÄ± bul: mod = 'nextWithSeats' ise yolcusu olan ilk duraÄŸÄ± dÃ¶ndÃ¼rÃ¼r,
// 'strictNext' ise sÄ±radaki fiziksel duraÄŸÄ± (yolcusu olmasa da) dÃ¶ndÃ¼rÃ¼r.
function computeNextStopName(currentName, mod='nextWithSeats'){
  if (!Array.isArray(cachedStops) || !cachedStops.length) return '';
  const curIdx = indexOfStopByName(currentName);
  let i = (curIdx >= 0 ? curIdx + 1 : 0);

  if (mod === 'strictNext') {
    return cachedStops[i]?.name || '';
  }

  // nextWithSeats: ileriye doÄŸru yolcusu olan ilk durak
  for (; i < cachedStops.length; i++){
    const nm = cachedStops[i]?.name;
    if (nm && hasPassengersFor(nm)) return nm;
  }
  // BulunamadÄ±ysa rota bitmiÅŸtir
  return '';
}

// Select'i gÃ¼venle gÃ¼ncelle ve yan efektleri tetikle
function setSelectedStop(name, {silent=false} = {}){
  const sel = $('#alertStop');
  if (!sel) return;

  if (!name) {
    sel.value = '';
    updateGeoHint();
    refreshStopBadges();
    updateStopBadgesForSelected();
    return;
  }

  // Option var mÄ±?
  const ok = [...sel.options].some(o => norm(o.value) === norm(name));
  if (!ok) return;

  sel.value = name;
  updateGeoHint();
  refreshStopBadges();
  updateStopBadgesForSelected();
  
  if (!silent) {
    if (isFinalStop(name)) {
      speakFinalStopSequence(name);
    } else {
      const seats = seatsForStop(name);
      speak(`SÄ±radaki Durak ${name}. Bu durakta ${seats.length} yolcu inecek.`);
    }
  }
}

// Yeni:
function advanceToNextStop({ mode='nextWithSeats', silent=false, ignoreToggle=false } = {}){
  const autoOn = $('#autoAdvanceToggle')?.checked;
  if (autoOn === false && !ignoreToggle) return;  // toggle kapalÄ±ysa sadece ignoreToggle=false iken dur
  const cur = getSelectedStopName();
  const next = computeNextStopName(cur, mode);
  if (!next){
    toast('ðŸ§­ Rota bitti ya da ileride yolcusu olan durak yok.');
    setSelectedStop('', {silent:true});
    return;
  }
  setSelectedStop(next, {silent});
}

/* === Koordinat yardÄ±mcÄ±larÄ± === */
window.numTR = function(v){ const s=String(v ?? '').trim().replace(',', '.'); const n=parseFloat(s); return Number.isFinite(n)?n:NaN; };

window.refetchCoordsIntoCache = async function(){
  try{
    const cj = await safeJsonFetch('/api/coords');
    if (cj?.ok) {
      const byStop = new Map((cj.items || []).map(i => [i.stop, { lat: i.lat, lng: i.lng }]));
      if (Array.isArray(cachedStops)) {
        cachedStops = cachedStops.map(s => byStop.has(s.name) ? { ...s, ...byStop.get(s.name) } : s);
      }
    }
  }catch(_){}
};

/* AYAKTA POPOVER */
function openStandingPopover(){
  const tile = $('#tileStanding'), pop = $('#standingPopover'), back = $('#standingBackdrop');
  if(!tile || !pop || !back) return;
  if (typeof renderStandingList === 'function') renderStandingList();

  const prevDisp = pop.style.display, prevVis = pop.style.visibility;
  pop.style.visibility = 'hidden'; pop.style.display = 'block'; pop.style.left = '0px'; pop.style.top = '0px';
  try{
    const r = tile.getBoundingClientRect(), vw = document.documentElement.clientWidth, vh = document.documentElement.clientHeight;
    const pw = pop.offsetWidth || 320, ph = pop.offsetHeight || 180, margin = 8;
    let left = r.left + window.scrollX, top = r.bottom + margin + window.scrollY;
    const minL = window.scrollX + margin, maxL = window.scrollX + vw - pw - margin; left = Math.max(minL, Math.min(maxL, left));
    const maxBottom = window.scrollY + vh - margin;
    if (top + ph > maxBottom) { top = r.top + window.scrollY - ph - margin; if (top < window.scrollY + margin) top = window.scrollY + margin; }
    pop.style.left = left + 'px'; pop.style.top = top + 'px';
  }catch(_){
    const r = tile.getBoundingClientRect();
    pop.style.left = (r.left + window.scrollX) + 'px';
    pop.style.top = (r.bottom + 8 + window.scrollY) + 'px';
  }finally{
    pop.style.visibility = 'visible'; pop.style.display = 'block'; back.style.display = 'block';
  }
}
function closeStandingPopover(){ const back=$('#standingBackdrop'); const pop=$('#standingPopover'); if(back) back.style.display='none'; if(pop) pop.style.display='none'; }
function renderStandingList(){
  const list = $('#standingList'), sumEl = $('#standingSummary'), bulkBt = $('#standingBulkOff');
  if(!list || !sumEl || !bulkBt) return;
  const rows = [];
  standingItems.forEach(it => { const c=Number(it?.count||0); for(let i=0;i<c;i++) rows.push(it); });
  list.innerHTML='';
  if(rows.length===0){ sumEl.textContent='KayÄ±t yok'; bulkBt.style.display='none'; return; }
  let totalPrice=0; standingItems.forEach(it => totalPrice += (Number(it?.price)||0) * (Number(it?.count)||0));
  sumEl.textContent = `${rows.length} ayakta â€¢ ${fmtTL(totalPrice)}`;
  bulkBt.style.display = rows.length > 1 ? 'inline-flex' : 'none';
  const frag=document.createDocumentFragment();
  rows.forEach((it, idx)=>{
    const from=it.from||'â€”', to=it.to||'â€”';
    const d=document.createElement('div'); d.className='item';
    d.innerHTML = `<div class="who">${from} â†’ ${to}</div><div class="actions"><button class="btn danger off-one" data-idx="${idx}" aria-label="Bu kiÅŸiyi indir">Ä°ndir</button></div>`;
    frag.appendChild(d);
  });
  list.appendChild(frag);
  list.querySelectorAll('button.off-one').forEach(btn=>{
    btn.addEventListener('click', ()=>{ const idx=parseInt(btn.dataset.idx,10); removeStandingByIndex(idx); });
  });
}
function removeStandingByIndex(idx){
  const expand=[]; standingItems.forEach(it=>{ for(let i=0;i<it.count;i++) expand.push(it); });
  const target=expand[idx]; if(!target) return;
  target.count -= 1; if(target.count<=0){ const at=standingItems.indexOf(target); if(at>=0) standingItems.splice(at,1); }
  standingCount = Math.max(0, standingCount - 1);
  persistStandingItems(); persistStandingTotals(); updateStats(); renderStandingList();
}

/* Saat */
(function(){ const t=$('#clockMain'), d=$('#clockSub'); if(!t||!d) return;
  const f=new Intl.DateTimeFormat('tr-TR',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  const fd=new Intl.DateTimeFormat('tr-TR',{day:'2-digit',month:'long',year:'numeric',weekday:'long'});
  const tick=()=>{const n=new Date(); t.textContent=f.format(n); d.textContent=fd.format(n)}; tick(); setInterval(tick,500);
})();

/* Durak/Koord */
async function fetchStops(){
  const j=await safeJsonFetch('/api/stops'); if(!j.ok) throw new Error(j.msg||'Duraklar alÄ±namadÄ±');
  let stops=(j.stops||[]).map(name=>({name,lat:null,lng:null}));
  try{
    const cj=await safeJsonFetch('/api/coords');
    if(cj.ok){
      const map=new Map((cj.items||[]).map(i=>[i.stop,{lat:i.lat,lng:i.lng}]));
      stops=stops.map(s=>map.has(s.name)?{...s,...map.get(s.name)}:s);
    }
  }catch(_){}
  cachedStops=stops; return stops;
}

async function populateStopsToSelects(){
  if(!cachedStops) await fetchStops();
  const ids = ['pickup','dropoff','alertStop','bulkFrom','bulkTo','cashFrom','cashTo'];
  for (const id of ids){
    const el = $('#'+id); if(!el) continue;
    const prev = el.value;
    el.innerHTML = '';
    const first = document.createElement('option'); first.value = ''; first.textContent = 'â€”'; el.appendChild(first);
    for (const s of cachedStops){
      const o = document.createElement('option');
      o.value = s.name;
      o.dataset.label = s.name; // ham metin
      o.textContent = s.name + (s.lat!=null ? ' â€¢' : '');
      el.appendChild(o);
    }
    if(prev && [...el.options].some(o=>o.value===prev)) el.value=prev;
  }
  updateGeoHint();
}

function norm(s){return (s||'').toString().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase()}
function findStopByName(name){ const t=norm(name); for(const x of (cachedStops||[])){ if(norm(x?.name)===t) return x;} return null; }
function hasCoord(s){ if(!s || s.lat == null || s.lng == null) return false; const lat=parseFloat(s.lat), lng=parseFloat(s.lng); return Number.isFinite(lat) && Number.isFinite(lng); }

function updateCoordPanel(){
  const stopName = $('#alertStop')?.value || '';
  const s = stopName ? findStopByName(stopName) : null;
  const inp = $('#coordStopName'); if (inp) inp.value = stopName || '';
  const pnl = $('#coordPanel'); if (!pnl) return;
  if(!stopName){ pnl.style.display='none'; return; }
  pnl.style.display = hasCoord(s) ? 'none' : 'block';
}

function updateGeoHint(){
  if (geoWatchId) return;
  const stopName = $('#alertStop')?.value || '';
  const h = $('#geoHint'); if (!h) return;
  if(!stopName){ h.textContent='Durak seÃ§.'; updateCoordPanel(); return; }
  const s = findStopByName(stopName);
  h.textContent = hasCoord(s) ? 'Koordinat hazÄ±r.' : 'Koordinat yok â€” aÅŸaÄŸÄ±dan ekleyin.';
  updateCoordPanel();
}

/* Koltuk UI */
function setServiceBadge(el, on){ if(!el) return; el.classList.toggle('has-service', !!on); }
function applySeatColor(el, gender, isAssigned){
  if(!el) return;
  if (gender === 'bay')      el.style.background = '#2d6cdf';
  else if (gender === 'bayan') el.style.background = '#e75480';
  else                         el.style.background = isAssigned ? '#4a6177' : '#1f6b2d';
}
function positionFormOnSeat(seatEl){
  const f = $('#seatForm'); if(!f || !seatEl) return;
  f.style.display = 'block';
  const r = seatEl.getBoundingClientRect();
  const w = f.offsetWidth || 320, h = f.offsetHeight || 240;
  let L = r.left + r.width/2, T = r.top - 8, transform='translate(-50%,-100%)';
  if (r.top - h - 16 < 0){ T = r.bottom + 8; transform='translate(-50%,0)'; }
  const vw = document.documentElement.clientWidth; L = Math.max(8 + w/2, Math.min(vw - 8 - w/2, L));
  f.style.left = L + 'px'; f.style.top = T + 'px'; f.style.transform = transform;
}
function repositionSeatForm(){ if(!currentSeat) return; const seatEl = $('#seat-'+currentSeat), form=$('#seatForm'); if(!seatEl || !form || form.style.display==='none') return; positionFormOnSeat(seatEl); }

function handleSeatClick(n){ if(multiMode) return; openFormWithSeat(n); }

async function openFormWithSeat(n){
  currentSeat = n;
  $$('.seat.selected').forEach(el => el.classList.remove('selected'));
  const seatEl = $('#seat-'+n);
  if(seatEl){ seatEl.classList.add('selected'); const f=$('#seatForm'); f.style.display='block'; positionFormOnSeat(seatEl); }
  $('#seatTitle').innerText = 'Koltuk ' + n;
  try { await populateStopsToSelects(); } catch(e){ toast(e.message || 'Duraklar yÃ¼klenemedi'); }
  const prevFrom = boardsMap?.[String(n)] || ($('#alertStop')?.value || '');
  if(prevFrom) $('#pickup').value = prevFrom;
  const prevStop = stopsMap[String(n)] || '';
  if(prevStop) $('#dropoff').value = prevStop;

  document.querySelector('input[name="ticket"][value="biletsiz"]').checked = true;
  document.querySelector('input[name="pay"][value="nakit"]').checked = true;
  $('#price').value = '0.00';

  const prevGender = genders[String(n)] || "";
  const gEl = document.querySelector('input[name="gender"][value="'+prevGender+'"]');
  if (gEl) gEl.checked = true; else (document.querySelector('input[name="gender"][value=""]')||{}).checked = true;

  $('#service').checked = !!serviceMap[String(n)];
  $('#service_note').value   = service_notes[String(n)] || "";
  $('#pairOk').checked      = false;
}
function closeForm(){ $('#seatForm').style.display='none'; $$('.seat.selected').forEach(el=>el.classList.remove('selected')); currentSeat=null; }

/* Tekli kaydet */
async function saveSeat(){
  if(!currentSeat) return;
  const from = $('#pickup')?.value || $('#alertStop')?.value || '';
  const stop = $('#dropoff')?.value || '';
  const ticket = document.querySelector('input[name="ticket"]:checked')?.value || 'biletsiz';
  const pay    = document.querySelector('input[name="pay"]:checked')?.value    || 'nakit';
  const amount = parseMoney($('#price')?.value || 0);
  const gender = document.querySelector('input[name="gender"]:checked')?.value || '';
  const pair_ok = $('#pairOk')?.checked ? 1 : 0;
  const service = $('#service')?.checked || false;
  const service_note = $('#service_note')?.value || '';
  try{
    const j = await safeJsonFetch('/api/seat',{
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRF-Token':csrf},
      body: JSON.stringify({ seat_no: currentSeat, from, stop, ticket_type: ticket, payment: pay, amount, gender, pair_ok, service, service_note })
    });
    if(!j.ok) throw new Error(j.msg || 'KayÄ±t baÅŸarÄ±sÄ±z');

    assigned[String(currentSeat)]    = true;
    stopsMap[String(currentSeat)]    = stop;
    genders[String(currentSeat)]     = gender;
    serviceMap[String(currentSeat)]  = !!service;
    service_notes[String(currentSeat)]= service_note;
    boardsMap[String(currentSeat)]   = from;
    persistBoardsMapToLS();

    const l = $('#label-'+currentSeat); if(l) l.textContent = (from ? (from + ' â†’ ') : '') + (stop || '');
    const s = $('#seat-'+currentSeat); if(s){ applySeatColor(s, gender, true); setServiceBadge(s, !!service); s.classList.add('isAssigned'); }
    closeForm(); updateStats(); refreshStopBadges();
  }catch(e){ toast(e.message || 'Kaydetme hatasÄ±'); }
}

/* Tekli boÅŸalt */
async function offloadSeat(){
  if (!currentSeat) return;

  try {
    const j = await safeJsonFetch('/api/seat?seat_no=' + currentSeat, {
      method: 'DELETE',
      headers: { 'X-CSRF-Token': csrf }
    });
    if (!j.ok) throw new Error(j.msg || 'Silme baÅŸarÄ±sÄ±z');

    // ðŸ§³ Bu koltuÄŸa baÄŸlÄ± tÃ¼m bagajlarÄ± da sil
    await clearBagsForSeat(currentSeat);

    // UI temizliÄŸi
    clearSeatUI(currentSeat);               // koltuÄŸu boÅŸalt (has-stop dahil)
    stopBlink([currentSeat]);               // varsa sarÄ± yanÄ±p sÃ¶nmeyi durdur
    closeForm();
    updateStats();
    refreshStopBadges();                    // select iÃ§indeki sayaÃ§larÄ± gÃ¼ncelle
    updateStopBadgesForSelected();          // ekrandaki ðŸ”” rozetlerini yeniden hesapla

  } catch (e) {
    toast(e.message || 'Ä°niÅŸ/boÅŸaltma hatasÄ±');
  }
}

/* Bir koltuÄŸu tamamen temizle */
function clearSeatUI(n){
  delete assigned[String(n)];
  delete stopsMap[String(n)];
  delete genders[String(n)];
  delete serviceMap[String(n)];
  delete service_notes[String(n)];
  const l = $('#label-'+n); if (l) l.textContent = '';
  const s = $('#seat-'+n); if (s){ applySeatColor(s, "", false); setServiceBadge(s, false); s.classList.remove('isAssigned','multi-picked','blink-yellow'); }
}

/* === Ã‡oklu seÃ§im yardÄ±mcÄ±larÄ± === */
function clearMultiPicks(){ for (const el of multiSelected) el.classList.remove('multi-picked'); multiSelected.clear(); }
function toggleSeatPick(el){ if(el.classList.contains('isAssigned')) return; if(multiSelected.has(el)){ multiSelected.delete(el); el.classList.remove('multi-picked'); } else { multiSelected.add(el); el.classList.add('multi-picked'); } }
function enableMultiMode(on){
  multiMode = !!on;
  const cb = $('#multiPick'); if (cb) cb.checked = multiMode;
  if (multiMode){ closeBulk(); toast('Ã‡oklu seÃ§im AÃ‡IK. KoltuklarÄ± iÅŸaretleyin, sonra paneli aÃ§Ä±p Kaydet.'); }
  else { clearMultiPicks(); toast('Ã‡oklu seÃ§im KAPALI.'); }
}
$('#multiPick')?.addEventListener('change', (e)=>{ enableMultiMode(e.target.checked); });

/* Koltuklara doÄŸrudan dinleyici: multiMode aÃ§Ä±kken seÃ§im */
document.querySelectorAll('.seat').forEach(el => {
  el.addEventListener('click', (ev) => {
    if (!multiMode) return;
    ev.preventDefault(); ev.stopPropagation();
    toggleSeatPick(el);
  }, true);
});

/* Delegation â€“ deck iÃ§inde tÄ±klama */
$('#deck')?.addEventListener('click',(e)=>{
  if (!multiMode) return;
  let seatEl = e.target.closest('.seat');
  if (!seatEl) { const cell = e.target.closest('.cell'); if (cell) seatEl = cell.querySelector('.seat'); }
  if (!seatEl) return;
  e.preventDefault(); e.stopPropagation();
  toggleSeatPick(seatEl);
});

/* YaklaÅŸma */
function seatsForStop(stop){ const out=[]; for(const [seat, st] of Object.entries(stopsMap||{})){ if(st===stop) out.push(Number(seat)); } return out.sort((a,b)=>a-b); }
function updateStopBadgesForSelected(){ const stop = $('#alertStop')?.value || '';
  // Ã¶nce tÃ¼m iÅŸaretleri temizle
  $$('.seat').forEach(el => el.classList.remove('has-stop'));
  if (!stop) return;

  // bu durakta inecek koltuklarÄ± iÅŸaretle
  const seats = seatsForStop(stop);
  seats.forEach(n => {
    const el = $('#seat-' + n);
    if (el) el.classList.add('has-stop');
  });
}
function speak(text){ if(!$('#soundToggle').checked) return; try{ const u=new SpeechSynthesisUtterance(text); u.lang='tr-TR'; window.speechSynthesis.speak(u);}catch(_){} if(navigator.vibrate) navigator.vibrate([150,70,150]); }
function openApproachPanel(stop,seats){
  lastApproach={stop,seats:[...seats]};
  $('#approachTitle').textContent=stop+' yaklaÅŸÄ±yor';
  $('#approachInfo').textContent=seats.length?(seats.length+' yolcu inecek'):'Bu durakta iniÅŸ yok.';
  const listEl=$('#approachList'); listEl.innerHTML=''; if(seats.length){const ul=document.createElement('ul'); ul.style.margin='6px 0'; ul.style.paddingLeft='18px'; for(const s of seats){ const li=document.createElement('li'); li.textContent='Koltuk '+s; ul.appendChild(li);} listEl.appendChild(ul);}
  $('#approachBackdrop').style.display='block'; $('#approachPanel').style.display='block';
  if (isFinalStop(stop)) { speakFinalStopSequence(stop);} else {speak(`SÄ±radaki Durak ${stop}. Bu durakta ${seats.length} yolcu inecek.`);
  // ðŸ“¦ emanet uyarÄ±sÄ±
  const pCounts = computeParcelCountsByStop();
  if (pCounts[stop]) {
    toast(`ðŸ“¦ Bu durakta ${pCounts[stop]} emanet var!`);
  }
}
}

function showGhostOffload(){
  const btn = document.getElementById('btnGhostOffload');
  if (!btn || !lastApproach?.seats?.length) return;

  // butonu gÃ¶rÃ¼nÃ¼r yap
  btn.style.display = 'inline-flex';

  // 5 sn sonra kendiliÄŸinden gizle (dokunulmazsa)
  clearTimeout(showGhostOffload._t);
  showGhostOffload._t = setTimeout(()=>{ btn.style.display = 'none'; }, 5000);
}

function closeApproachPanel(){ $('#approachBackdrop').style.display='none'; $('#approachPanel').style.display='none'; }
$('#approachClose').addEventListener('click',()=>{ closeApproachPanel(); showGhostOffload(); });
$('#approachSnooze').addEventListener('click',()=>{ snoozeBlink(); showGhostOffload(); });
$('#approachBackdrop').addEventListener('click',()=>{ closeApproachPanel(); showGhostOffload(); });

/* Toplu indir (panel iÃ§i) */
$('#approachOffload')?.addEventListener('click', async () => {
  // ðŸ“¦ Ã¶nce emanet uyarÄ±sÄ±nÄ± gÃ¶ster
  const stop = lastApproach?.stop;
  const pCounts = computeParcelCountsByStop();
  if (stop && pCounts[stop]) {
    toast(`ðŸ“¦ ${stop} iÃ§in ${pCounts[stop]} emanet var!`);
  }

  if (!lastApproach?.stop) return;
  await bulkOffload(lastApproach.seats);
  await offloadStandingForStop(lastApproach.stop);
  closeApproachPanel();
});

/* Ghost BOÅžALT butonu */
$('#btnGhostOffload').addEventListener('click', async ()=>{
  await bulkOffload(lastApproach.seats);
  await offloadStandingForStop(lastApproach.stop);
  $('#btnGhostOffload').style.display='none';
  advanceToNextStop({mode:'nextWithSeats', ignoreToggle:true});
});

// Toplu boÅŸaltma
async function bulkOffload(seatNums){
  if (!Array.isArray(seatNums) || seatNums.length === 0) return;
  try{
    // 1) API
    let ok = false;
    try{
      const j = await safeJsonFetch('/api/seats/offload', {
        method: 'POST',
        headers: {'Content-Type':'application/json','X-CSRF-Token': csrf},
        body: JSON.stringify({ seats: seatNums })
      });
      ok = !!j.ok;
    }catch(_){}

    if (!ok){
      // toplu yoksa tek tek sil
      for (const n of seatNums){
        const j = await safeJsonFetch('/api/seat?seat_no=' + n, {
          method:'DELETE',
          headers:{'X-CSRF-Token': csrf}
        });
        if (!j.ok) throw new Error(j.msg || ('Koltuk ' + n + ' boÅŸaltÄ±lamadÄ±'));
      }
    }

// 2) UI + bagaj
    for (const n of seatNums){
      await clearBagsForSeat(n);       // ðŸ§³ Ã¶nce bagajlarÄ± temizle
      clearSeatUI(n);                  // sonra koltuk bilgisini sÄ±fÄ±rla
      const el = document.getElementById('seat-' + n);
      el?.classList.remove('has-stop');
    }
    stopBlink(seatNums);
    updateStats();
    refreshStopBadges();
    updateStopBadgesForSelected();
    toast('âœ” ' + seatNums.length + ' koltuk boÅŸaltÄ±ldÄ±');
    lastApproach = { stop:null, seats:[] };

// Saat kutusu: tek tÄ±k "Ä°necekleri indir"
  document.getElementById('btnOffloadNow')?.addEventListener('click', async () => {
  const stop = document.getElementById('alertStop')?.value || '';
  if (!stop) { toast('Ã–nce SÄ±radaki Durak seÃ§.'); return; }

  const seats = seatsForStop(stop);
  if (!seats.length) { toast('Bu durakta inecek yok.'); return; }

  const ok = confirm(`"${stop}" iÃ§in ${seats.length} yolcuyu indireyim mi?`);
  if (!ok) return;

  // 1) Ã¶nce boÅŸalt
  await bulkOffload(seats);
  const stopName = document.getElementById('alertStop')?.value || '';
  const removed = await offloadStandingForStop(stopName);
  if (removed > 0) toast(`âœ” Ayakta ${removed} kiÅŸi indirildi`);
  
  // 2) sonra (emniyet iÃ§in) rozet/sayaÃ§larÄ± tazele
  refreshStopBadges();
  updateStopBadgesForSelected();

  // 3) bir sonrakine otomatik geÃ§
advanceToNextStop({ mode: 'nextWithSeats', ignoreToggle: true });
});

/* Geo watch */
$('#btnTriggerNow').addEventListener('click', ()=>{
  const stop=$('#alertStop')?.value||''; if(!stop){ toast('Durak seÃ§.'); return; }
  const seats=seatsForStop(stop);
  if (!seats.length){ toast('Bu durakta iniÅŸ yok. Ä°leri atlanÄ±yorâ€¦'); advanceToNextStop({mode:'nextWithSeats'}); return; }
  openApproachPanel(stop,seats); startBlink(seats);
});

const geoBtn=$('#btnGeoWatch'); geoBtn?.addEventListener('click', onGeoWatchToggle);
async function onGeoWatchToggle(){
  if(geoWatchId){ navigator.geolocation.clearWatch(geoWatchId); geoWatchId=null; geoBtn.textContent='Konumu Ä°zle: KAPALI'; updateGeoHint(); toast('Konum izleme kapatÄ±ldÄ±.'); return; }
  try{ if(!cachedStops) await fetchStops(); }catch(e){ toast(e.message||'Durak listesi alÄ±namadÄ±'); return; }
  const stopName=($('#alertStop')?.value||'').trim(); if(!stopName){ toast('Ã–nce durak seÃ§.'); return; }
  const s=findStopByName(stopName); if(!s || s.lat==null || s.lng==null){ toast('Bu durak iÃ§in koordinat yok. AÅŸaÄŸÄ±dan ekleyin.'); return; }
  const radiusKm=parseFloat($('#alertRadius')?.value||'3'); const hint0=$('#geoHint'); if(hint0) hint0.textContent='Mesafe: hesaplanÄ±yorâ€¦';
  geoWatchId=navigator.geolocation.watchPosition((pos)=>{ const p={lat:pos.coords.latitude,lng:pos.coords.longitude}; const d=distKm(p,{lat:s.lat,lng:s.lng}); const h=$('#geoHint'); if(h) h.textContent=`Mesafe: ${d.toFixed(2)} km (eÅŸik ${radiusKm} km)`; if(d<=radiusKm){ const now=Date.now(); if((now-lastAlertAt)>ALERT_COOLDOWN_MS && now>=snoozeUntil){ lastAlertAt=now; const seats=seatsForStop(stopName); openApproachPanel(stopName,seats); startBlink(seats);} } },(err)=>toast('Konum hatasÄ±: '+(err?.message||'')),{enableHighAccuracy:true,timeout:10000,maximumAge:2000});
  geoBtn.textContent='Konumu Ä°zle: AÃ‡IK';
}

/* Blink */
function startBlink(list){ if(!Array.isArray(list)||!list.length) return; list.forEach(n=>{ pendingDrops.add(n); const el=$('#seat-'+n); if(el) el.classList.add('blink-yellow'); }); }
function stopBlink(list){ const arr=list?[...list]:[...pendingDrops]; arr.forEach(n=>{ const el=$('#seat-'+n); if(el) el.classList.remove('blink-yellow'); pendingDrops.delete(n); }); }
function snoozeBlink(ms=5*60*1000){ stopBlink(); snoozeUntil=Date.now()+ms; toast('â° UyarÄ± 5 dk ertelendi'); }

/* Stats */
function updateStats(){
  const totalSeats = Object.keys({{ seats_map | tojson | safe }}).length;
  const filled = Object.values(assigned||{}).filter(Boolean).length;
  const empty  = totalSeats - filled;
  const occ = totalSeats ? Math.round((filled/totalSeats)*100) : 0;
const paxText = (standingCount > 0) ? `${filled} + ${standingCount}` : `${filled}`;
$('#st_totalPax').textContent = paxText;
// Ä°stersen toplamÄ± ipucu olarak gÃ¶sterelim:
$('#st_totalPax').title = `Toplam: ${filled + standingCount} (oturan ${filled}, ayakta ${standingCount})`;  
  $('#st_empty').textContent = String(empty);
  $('#st_occupancy').textContent = occ + '%';
  $('#st_standing').textContent = String(standingCount);
  $('#st_standingTL').textContent = fmtTL(standingRevenue);
}
// Toplu GiriÅŸ panel referanslarÄ± + kapat
const bulkBackdrop = $('#bulkBackdrop');
const bulkPanel    = $('#bulkPanel');

function closeBulk(){
  if (bulkBackdrop) bulkBackdrop.style.display = 'none';
  if (bulkPanel)    bulkPanel.style.display    = 'none';
}

// Kapatma dinleyicileri (buton + arka plan)
$('#bulkClose')?.addEventListener('click', closeBulk);
$('#bulkBackdrop')?.addEventListener('click', closeBulk);

$('#bulkBackdrop')?.addEventListener('click', ()=>{
  const keepMulti = $('#multiPick')?.checked;
  if (keepMulti) multiMode = true; else { multiMode = false; clearMultiPicks(); }
  closeBulk();
});

function openBulk(){
  // SeÃ§enekleri doldur
  populateStopsToSelects();
  // panel aÃ§Ä±lÄ±rken checkbox, mevcut moda eÅŸitlensin
const cb = $('#multiPick');
if (cb) cb.checked = !!multiMode;  

  // Geofence Ã§ubuÄŸunda seÃ§ili durak varsa "Nereye" alanÄ±na getir
  const a = $('#alertStop')?.value || '';
  const toSel = $('#bulkTo');
  if (a && toSel) toSel.value = a;

  // Paneli aÃ§
  bulkBackdrop.style.display = 'block';
  bulkPanel.style.display = 'block';
}

$('#bulkSave')?.addEventListener('click', async ()=>{
  // SeÃ§imler
  const from = $('#bulkFrom')?.value || '';
  const to   = $('#bulkTo')?.value   || '';
  const count = Math.max(1, parseInt($('#bulkCount')?.value || '1', 10));
  const ticketVal = document.querySelector('input[name="bulkTicket"]:checked')?.value || 'biletsiz';
  const useService = $('#bulkService')?.checked || false;

  if (!to) { toast('Nereye (iniÅŸ) seÃ§.'); return; }

// Hedef koltuklar
const chosen = [...multiSelected].map(el => Number(el.dataset.seat));
let targets = [];

if (multiMode) {
  // Ã‡oklu seÃ§im aÃ§Ä±k: kullanÄ±cÄ± koltuk seÃ§mek zorunda
  if (!chosen.length){
    toast('Ã‡oklu seÃ§im aÃ§Ä±k. KoltuklarÄ± seÃ§, sonra tekrar Kaydet.');
    return;
  }
  targets = chosen;
} else {
  // Ã‡oklu seÃ§im kapalÄ±: boÅŸ koltuklardan rastgele doldur
  const empties = [];
  for (const el of $$('.seat')) {
    const no = el.dataset.seat;
    if (!assigned?.[no]) empties.push(Number(no));
  }
  if (!empties.length){ toast('BoÅŸ koltuk kalmadÄ±'); return; }
  targets = sampleRandom(empties, count);
}

  try {
    // 1) Varsa toplu endpoint
    let ok = false;
    try {
      const j = await safeJsonFetch('/api/seats/bulk', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRF-Token':csrf},
        body: JSON.stringify({
          seats: targets,
          from, stop: to,
          ticket_type: ticketVal,
          service: useService
        })
      });
      ok = !!j.ok;
    } catch (_) {}

    // 2) Yoksa tek tek gÃ¶nder
    if (!ok) {
      for (const n of targets) {
        await safeJsonFetch('/api/seat', {
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRF-Token':csrf},
          body: JSON.stringify({
            seat_no: n,
            from, stop: to,               // backend "from"u yok sayabilir; sorun deÄŸil
            ticket_type: ticketVal,
            payment: 'nakit',
            amount: 0,
            gender: '',
            pair_ok: 0,
            service: useService,
            service_note: ''
          })
        });
      }
    }

// 3) UI gÃ¼ncelle
for (const n of targets) {
  assigned[String(n)]  = true;
  stopsMap[String(n)]  = to;       // iniÅŸ
  boardsMap[String(n)] = from;     // biniÅŸ

  const el = $('#seat-' + n);
  if (el) {
    el.classList.add('isAssigned');
    applySeatColor(el, "", true);
    setServiceBadge(el, useService);
  }

  const l = $('#label-' + n);
  if (l) l.textContent = (from ? (from + ' â†’ ') : '') + to;
}
persistBoardsMapToLS();

clearMultiPicks();
multiMode = false;
const cb = $('#multiPick');
if (cb) cb.checked = false;

closeBulk();
toast('âœ” ' + targets.length + ' koltuk eklendi');
updateStats();
refreshStopBadges();
} catch (err) { toast(err?.message || 'KayÄ±t hatasÄ±'); } });


/* HÄ±zlÄ± Tahsilat paneli */
const cashBackdrop = $('#cashBackdrop'), cashPanel = $('#cashPanel');

function openCash(){
  populateStopsToSelects();
  // SeÃ§ili SÄ±radaki Durak varsa "Nereye" alanÄ±na getir
  const a = $('#alertStop')?.value || '';
  if (a) { const toSel = $('#cashTo'); if (toSel) toSel.value = a; }
  cashBackdrop.style.display = 'block';
  cashPanel.style.display    = 'block';
}
function closeCash(){
  cashBackdrop.style.display = 'none';
  cashPanel.style.display    = 'none';
}

$('#cashBackdrop')?.addEventListener('click', closeCash);
$('#cashClose')?.addEventListener('click', closeCash);

$('#cashSave')?.addEventListener('click', async ()=>{
  const cnt   = Math.max(1, parseInt($('#cashCount')?.value || '1', 10));
  const price = parseMoney($('#cashPrice')?.value || 0);
  const pay   = $('#cashPay')?.value || 'nakit';
  const from  = $('#cashFrom')?.value || '';
  const to    = $('#cashTo')?.value || '';
  const note  = $('#cashNote')?.value || '';

  try{
    // (Varsa) backend'e yaz, yoksa sessiz geÃ§
    try{
      const j = await safeJsonFetch('/api/standing', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRF-Token':csrf},
        body: JSON.stringify({count:cnt, price, payment:pay, from, to, note})
      });
      if(!j.ok) throw new Error('NO_STANDING');
    }catch(_){}

    // 1) ToplamlarÄ± gÃ¼ncelle
    standingCount   += cnt;
    standingRevenue += cnt * price;
    persistStandingTotals();

    // 2) Detay listesine ekle (BURADA olmalÄ±)
    const toName = (findStopByName(to)?.name || to || '').trim();  // â† burayÄ± ekle

    const item = {
    id: Date.now(),
    from,
    to: toName,     // â† dÃ¼zeltildi
    count: cnt,
    price,
    payment: pay,
    note,
    ts: Date.now()
    };
    standingItems.push(item);
    persistStandingItems();

    // 3) UI
    updateStats();
    refreshStopBadges();     
    toast('âœ” Ayakta eklendi');
    closeCash();
    $('#cashCount').value = '1';
    $('#cashPrice').value = '0';
    $('#cashNote').value  = '';

  }catch(e){
    toast(e?.message || 'Tahsilat hatasÄ±');
  }
});

// Yeni sabit butonlar iÃ§in tÄ±klaâ€“aÃ§
$('#fabBulkFixed')?.addEventListener('click', openBulk);
$('#fabCashFixed')?.addEventListener('click', openCash);

/* Klavye & init */
window.addEventListener('keydown',e=>{ if(e.key==='Escape'){ closeForm(); closeApproachPanel(); closeBulk(); closeCash(); } });

window.addEventListener('scroll',  repositionSeatForm, {passive:true});
window.addEventListener('resize',  repositionSeatForm);
window.addEventListener('orientationchange', repositionSeatForm);

/* Init */
(async function init(){
  loadBoardsMapFromLS();

  // KoltuklarÄ± baÅŸlangÄ±Ã§ta boya/etiketle
  for (const el of $$('.seat')) {
    const seatNo = el.dataset.seat;
    const g      = genders?.[seatNo] || "";
    const isAssg = !!assigned?.[seatNo];

    if (isAssg) el.classList.add('isAssigned');
    applySeatColor(el, g, isAssg);

    const l = $('#label-' + seatNo);
    if (l) {
      const from = boardsMap?.[seatNo] || '';
      const to   = stopsMap?.[seatNo]  || '';
      l.textContent = isAssg ? (from ? (from + ' â†’ ' + to) : to) : '';
    }

    const svc = !!serviceMap?.[seatNo];
    setServiceBadge(el, svc);
    if (svc) {
      const note = (service_notes?.[seatNo] || "").trim();
      if (note) el.querySelector('.svc-badge').title = 'Servis: ' + note;
    }
  }

  // Paneller/istatistikler iÃ§in gerekli verileri yÃ¼kle
  $('#alertStop')?.addEventListener('change', updateGeoHint);
  await fetchStops();
  await populateStopsToSelects();
  await loadStandingTotals();
  await loadStandingItems();
  await loadParcelItems();   // â† yeni
  refreshBagsAll();  // ðŸ§³ bagaj ikonlarÄ±nÄ± koltuklara uygula
  refreshStopBadges();
  updateStopBadgesForSelected();
  updateStats();
})();

$('#alertStop')?.addEventListener('change', () => {
  updateGeoHint();
  // Cash panel aÃ§Ä±kken â€œNereyeâ€ otomatik senkron olsun
  const a = $('#alertStop')?.value || '';
  if (a && $('#cashPanel')?.style.display === 'block') {
    const toSel = $('#cashTo'); if (toSel) toSel.value = a;
  }
  // Toplu giriÅŸ panelinde de aynÄ± davranÄ±ÅŸ istersen:
  if (a && $('#bulkPanel')?.style.display === 'block') {
    const toSelB = $('#bulkTo'); if (toSelB) toSelB.value = a;
  }
  // rozetleri de tazeleyelim
  refreshStopBadges();
  updateStopBadgesForSelected();
});

/* Toplu indir: listedeki herkesi indir (sayÄ±yÄ± sÄ±fÄ±rlar, revenue deÄŸiÅŸmez) */
$('#standingBulkOff')?.addEventListener('click', ()=>{
  let totalPeople = 0;
  standingItems.forEach(it => totalPeople += (it.count || 0));
  standingItems.length = 0;
  standingCount = Math.max(0, standingCount - totalPeople);
  persistStandingItems();
  persistStandingTotals();
  updateStats();
  renderStandingList();
  refreshStopBadges();
});

/* AÃ§-kapa */
$('#tileStanding')?.addEventListener('click', openStandingPopover);
$('#standingClose')?.addEventListener('click', closeStandingPopover);
$('#standingBackdrop')?.addEventListener('click', closeStandingPopover);

$('#btnSaveCoord')?.addEventListener('click', async () => {
  try {
    const stop = ($('#alertStop')?.value || $('#coordStopName')?.value || '').trim();
    if (!stop) { toast('Ã–nce durak seÃ§.'); return; }

    const lat = numTR($('#coordLat')?.value), lng = numTR($('#coordLng')?.value);
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) { toast('Lat/Lng geÃ§ersiz'); return; }

    const j = await safeJsonFetch('/api/coords', {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRF-Token':csrf},
      body: JSON.stringify({ stop, lat, lng })
    });
    if (!j.ok) throw new Error(j.msg || 'KayÄ±t baÅŸarÄ±sÄ±z');

    await refetchCoordsIntoCache();  // cache'i tazele
    updateGeoHint();                 // â€œKoordinat hazÄ±r.â€ metni gelsin

    // âœ… Bildirim
    toast('âœ… Koordinat kaydedildi');

    // inputlarÄ± temizle (istenirse)
    $('#coordLat').value = '';
    $('#coordLng').value = '';
  } catch(e){
    toast(e?.message || 'Koordinat kaydedilemedi');
  }
});


/* =================== HIZ + LIMIT + TTS â€” TEK BLOK =================== */
(function () {
const spVal   = document.getElementById("spVal");
const spLimit = document.getElementById("spLimit");
const spTile  = document.getElementById("speedTile");
const clkTile = document.getElementById("clockTile");

// ---- YardÄ±mcÄ±lar
function setState(cls){
  [spTile, clkTile].forEach(el => {
    if (!el) return;
    el.classList.remove("limit-ok","limit-warn","limit-bad");
    if (cls) el.classList.add(cls);
  });
}

  function trHighway(hw){
    const m = {
      motorway:"otoyol", trunk:"bÃ¶lÃ¼nmÃ¼ÅŸ ana yol",
      primary:"birincil", secondary:"ikincil", tertiary:"Ã¼Ã§Ã¼ncÃ¼l",
      residential:"yerleÅŸim", service:"servis", living_street:"yaya Ã¶ncelikli"
    };
    return m[hw] || (hw || "");
  }
  function renderSpeed(v){ spVal.textContent = Math.round(v || 0); }

  // ---- Limit fetch (10 sn throttling)
  let lastLimitObj = null;
  let lastFetchTs  = 0;
  async function fetchLimit(lat, lng){
    const now = Date.now();
    if (now - lastFetchTs < 10_000 && lastLimitObj) return lastLimitObj;
    lastFetchTs = now;
    try{
      const r = await fetch(`/api/speedlimit?lat=${lat}&lng=${lng}`);
      const j = await r.json();
      if (j?.ok){
        lastLimitObj = { limit:j.limit, highway:j.highway, ts:now, from_cache:j.from_cache };
        return lastLimitObj;
      }
    }catch(_){}
    return null;
  }

  // ---- TTS (toggle + konuÅŸma)
  const TTS_LS_KEY = "ttsEnabled";
  let ttsEnabled = (localStorage.getItem(TTS_LS_KEY) ?? "1") === "1";
  const ttsBtn = document.getElementById("ttsToggle");
  if (ttsBtn){
    const syncBtn = ()=> ttsBtn.classList.toggle("muted", !ttsEnabled);
    syncBtn();
    ttsBtn.addEventListener("click", ()=>{
      ttsEnabled = !ttsEnabled;
      localStorage.setItem(TTS_LS_KEY, ttsEnabled ? "1" : "0");
      syncBtn();
      if (ttsEnabled) speakOnce("Sesli uyarÄ± aÃ§Ä±k.");
    });
  }
  let trVoice = null;
  function loadVoices(){
    const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
    trVoice = null;
    for (const v of voices){ if ((v.lang||"").toLowerCase().startsWith("tr")) { trVoice = v; break; } }
  }
  if ("speechSynthesis" in window){ loadVoices(); speechSynthesis.onvoiceschanged = loadVoices; }
  let ttsBusyUntil = 0;
  function speakOnce(text){
    if (!ttsEnabled || !("speechSynthesis" in window)) return;
    const now = Date.now(); if (now < ttsBusyUntil) return;
    const u = new SpeechSynthesisUtterance(text);
    if (trVoice) u.voice = trVoice; u.lang = trVoice ? trVoice.lang : "tr-TR"; u.rate = 1;
    u.onstart = ()=>{ ttsBusyUntil = Date.now() + 1500; };
    speechSynthesis.speak(u);
  }
  // TTS karar mantÄ±ÄŸÄ±
  let lastLimitValue = null, lastWarnOverAt = 0, lastWarnNearAt = 0, lastSafeSaid = 0;
  const i = (x)=> Math.round(Number(x||0));
  function maybeSayLimitChanged(limit){
    const L = i(limit);
    if (L && L !== lastLimitValue){ lastLimitValue = L; speakOnce(`Yeni hÄ±z limiti ${L}.`); }
  }
  function maybeSpeakBySpeed(spd, limit){
    const S = i(spd), L = i(limit); if (!L) return;
    const now = Date.now(), ratio = L>0 ? (S/L) : 0;

    // Turuncu
    if (ratio >= 0.85 && ratio < 1.0){
      if (now - lastWarnNearAt > 30_000){
        speakOnce(`HÄ±z limiti ${L}. Mevcut hÄ±z ${S}. LÃ¼tfen dikkat.`);
        lastWarnNearAt = now;
      }
      return;
    }
    // KÄ±rmÄ±zÄ±
    if (ratio >= 1.0){
      if (ratio >= 1.10){
        if (now - lastWarnOverAt > 12_000){
          speakOnce(`Tehlike. Limit ${L}, hÄ±z ${S}. Acil yavaÅŸlayÄ±n.`);
          lastWarnOverAt = now;
        }
      } else {
        if (now - lastWarnOverAt > 15_000){
          speakOnce(`Recep abi dikkat et. ${S} kilometre. Recep abi lÃ¼tfen gaz basma `);
          lastWarnOverAt = now;
        }
      }
      return;
    }
    // YeÅŸil
    if (ratio < 0.85 && now - lastSafeSaid > 45_000){
      speakOnce("Limit dahilindesiniz. TeÅŸekkÃ¼rler.");
      lastSafeSaid = now;
    }
  }

  // ---- Limit metni + renk + TTS tetik
  function renderLimit(limit, hw, speed){
    if (!limit){ spLimit.textContent = "Limit: â€”"; setState(""); return; }
    spLimit.textContent = `Limit: ${limit} km/h${hw ? ` â€¢ ${trHighway(hw)}` : ""}`;
    if (speed == null){ setState(""); return; }
    if (speed <= limit) setState("limit-ok");
    else if (speed <= limit + 10) setState("limit-warn");
    else setState("limit-bad");
    // TTS
    maybeSpeakBySpeed(speed, limit);
  }

  // ---- Geolocation watcher
  if ("geolocation" in navigator){
    navigator.geolocation.watchPosition(async (pos)=>{
      // hÄ±z m/s -> km/h
      const sp = pos.coords.speed;
      const kmh = (typeof sp === "number" && !isNaN(sp)) ? sp * 3.6 : null;
      if (kmh != null) renderSpeed(kmh);

      // limit Ã§ek
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      const lim = await fetchLimit(lat, lng);
      if (lim){
        renderLimit(lim.limit, lim.highway, kmh);
        maybeSayLimitChanged(lim.limit);
      }
    }, (err)=>{
      renderSpeed(0);
      spLimit.textContent = "GPS kapalÄ±";
      setState("");
    }, { enableHighAccuracy:true, maximumAge:3000, timeout:12000 });
  } else {
    spLimit.textContent = "Cihazda GPS yok";
  }
})(); 

function applyRing(el, level){ // level: "ok" | "warn" | "bad"
  if(!el) return;
  el.classList.add('premium');
  el.classList.remove('ring-ok','ring-warn','ring-bad','pulse');
  el.classList.add('ring-' + level);
}

function updateStats(){
  const totalSeats = Object.keys({{ seats_map | tojson | safe }}).length;
  const filled = Object.values(assigned||{}).filter(Boolean).length;
  const empty  = totalSeats - filled;
  const occ = totalSeats ? Math.round((filled/totalSeats)*100) : 0;

  const paxText = (standingCount > 0) ? `${filled} + ${standingCount}` : `${filled}`;
  $('#st_totalPax').textContent = paxText;
  $('#st_totalPax').title = `Toplam: ${filled + standingCount} (oturan ${filled}, ayakta ${standingCount})`;
  $('#st_empty').textContent = String(empty);
  $('#st_occupancy').textContent = occ + '%';
  $('#st_standing').textContent = String(standingCount);
  $('#st_standingTL').textContent = fmtTL(standingRevenue);

  // Ayakta kutusunda sadece nabÄ±z efekti (varsa)
  const stEl = document.getElementById('tileStanding');
  if (stEl){
    if (standingCount > 0) stEl.classList.add('pulse');
    else stEl.classList.remove('pulse');
  }
}

/* ===== Namaz vakti: sadece mevcut + sonraki + kalan ===== */
(function(){
  const PR_ORDER = ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'];
  const TR_PR    = { Fajr:'Ä°msak', Sunrise:'GÃ¼neÅŸ', Dhuhr:'Ã–ÄŸle', Asr:'Ä°kindi', Maghrib:'AkÅŸam', Isha:'YatsÄ±' };
  const METHOD=13, SCHOOL=0;
  const FALLBACK = { lat:38.5190, lng:28.5192, place:'AlaÅŸehir' };

  const lineEl = document.getElementById('pr-line');

  const pad2 = n => String(n).padStart(2,'0');
  const fmtHM = d => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

  // "05:23" veya "2025-09-20T05:23:00+03:00" -> Date
  function toTodayDate(s){
    if (!s) return null;
    if (s.includes('T')) return new Date(s);          // ISO
    const [h,m] = s.split(':').map(x=>parseInt(x,10));
    const d = new Date(); d.setHours(h||0,m||0,0,0);  // HH:MM
    return d;
  }

  function humanLeft(ms){
    const sec = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60);
    return (h?`${h} saat `:'') + `${m} dk`;
  }

  async function reverseGeocode(lat,lng){
    try{
      const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
      const a = (await r.json()).address || {};
      const town = a.village || a.town || a.hamlet || a.suburb || '';
      const dist = a.county || a.district || '';
      const prov = a.province || a.state || '';
      const right = dist && dist!==town ? dist : prov;
      return [town || right, right && right!==town ? right : ''].filter(Boolean).join(', ');
    }catch(_){ return ''; }
  }

  async function fetchTimings(lat,lng){
    const url = `https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lng}&method=${METHOD}&school=${SCHOOL}&iso8601=true`;
    const j = await (await fetch(url)).json();
    if (!j?.data?.timings) throw new Error('no timings');
    return j.data.timings;
  }

  function computePrevNext(timings){
    const now = new Date();
    const list = PR_ORDER.map(k => ({key:k, at: toTodayDate(timings[k])}))
                         .filter(x => x.at && !isNaN(x.at));
    const future = list.filter(x => x.at > now);
    if (future.length){
      const next = future[0];
      const i    = list.indexOf(next);
      const prev = i>0 ? list[i-1] : list[list.length-1];
      return {prev, next};
    }
    // gÃ¼n bitti â†’ yarÄ±n Fajr
    const prev = list[list.length-1];
    const tmr  = toTodayDate(timings['Fajr']); tmr.setDate(tmr.getDate()+1);
    return {prev, next:{key:'Fajr', at:tmr}};
  }

function render(place, timings){
  const {prev, next} = computePrevNext(timings);
  const placeTxt = place ? `${place}: ` : '';
  const curName  = TR_PR[prev.key] || prev.key;
  const nxtName  = TR_PR[next.key] || next.key;
  const curHH    = fmtHM(prev.at);
  const nxtHH    = fmtHM(next.at);

  const leftMs   = next.at - new Date();            // â† kalan sÃ¼re (ms)
  const leftTxt  = humanLeft(leftMs);

  lineEl.innerHTML =
    `${placeTxt}<span class="pr-accent">${curName} ${curHH}</span>`+
    ` <span class="muted">â€”</span> Sonraki: <b>${nxtName} ${nxtHH}</b>`+
    ` <span class="muted">â€¢</span> <span class="pr-left">Kalan ${leftTxt}</span>`;

  // â‰¤10 dk kala kÄ±rmÄ±zÄ± yanÄ±p sÃ¶nsÃ¼n
  const leftEl = lineEl.querySelector('.pr-left');
  if (leftEl) leftEl.classList.toggle('soon', leftMs <= 10*60*1000);
}

  async function boot(lat,lng,placeHint=''){
    try{
      const timings = await fetchTimings(lat,lng);
      const place = (await reverseGeocode(lat,lng)) || placeHint;
      render(place, timings);

      // her saniye kalan sÃ¼re gÃ¼ncellensin; gÃ¼n deÄŸiÅŸince tazele
      let lastDay = new Date().getDate();
      setInterval(async ()=>{
        const today = new Date().getDate();
        if (today !== lastDay){ lastDay = today; render(place, await fetchTimings(lat,lng)); }
        else render(place, timings);
      }, 1000);
    }catch(_){
      lineEl.textContent = 'Vakitler alÄ±namadÄ±';
    }
  }

  if ('geolocation' in navigator){
    navigator.geolocation.getCurrentPosition(
      p => boot(p.coords.latitude, p.coords.longitude),
      _ => boot(FALLBACK.lat, FALLBACK.lng, FALLBACK.place),
      { enableHighAccuracy:true, timeout:10000, maximumAge:30000 }
    );
  } else {
    boot(FALLBACK.lat, FALLBACK.lng, FALLBACK.place);
  }
})();

// ==== Bagaj yardÄ±mcÄ±larÄ± ====

const BAG_TRIP = "{{ (trip['route'] ~ '|' ~ trip['plate'])|replace(' ', '_') }}"; // dosya klasÃ¶rÃ¼ anahtarÄ±
window.BAG_TRIP = BAG_TRIP;  // ðŸ‘ˆ global yapÄ±yoruz

async function fetchBagCount(seatNo){
  try{
    const u = `/bags?trip=${encodeURIComponent(BAG_TRIP)}&seat=${encodeURIComponent(seatNo)}&format=json`;
    const j = await safeJsonFetch(u);
    return Number(j?.count || 0);
  }catch(_){ return 0; }
}

// Belirli bir koltuk iÃ§in TÃœM bagajlarÄ± sil + rozeti sÄ±fÄ±rla
async function clearBagsForSeat(seatNo){
  try{
    const u = `/bags/clear?trip=${encodeURIComponent(BAG_TRIP)}&seat=${encodeURIComponent(seatNo)}`;
    await safeJsonFetch(u, {
      method: 'DELETE',
      headers: { 'X-CSRF-Token': csrf }
    });
  }catch(_){
    // aÄŸ hatasÄ± olursa UI yine de temizlensin
  }

  const el = document.getElementById('seat-' + seatNo);
  if (el){
    el.classList.remove('has-bag');
    const bc = el.querySelector('.bag-badge .bag-count');
    if (bc) bc.textContent = '0';
  }
}

async function refreshBagBadgeForSeat(seatNo){
  const el = document.getElementById('seat-' + seatNo);
  if (!el) return;
  const cnt = await fetchBagCount(seatNo);
  el.classList.toggle('has-bag', cnt > 0);
  const bc = el.querySelector('.bag-badge .bag-count');
  if (bc) bc.textContent = String(cnt || 0);
}

async function refreshBagsAll(){
  const seats = Array.from(document.querySelectorAll('.seat'))
                      .map(el => Number(el.dataset.seat));
  for (const n of seats) await refreshBagBadgeForSeat(n);
}

// Rozete tÄ±klandÄ±ÄŸÄ±nda galeriye git
document.addEventListener('click', (e)=>{
  const badge = e.target.closest('.bag-badge');
  if (!badge) return;
  e.stopPropagation(); e.preventDefault();
  const seatEl = badge.closest('.seat');
  const n = seatEl?.dataset.seat;
  if (!n) return;
  const back = location.pathname; // geri dÃ¶nÃ¼ÅŸ iÃ§in
  location.href = `/bags?trip=${encodeURIComponent(BAG_TRIP)}&seat=${encodeURIComponent(n)}&next=${encodeURIComponent(back)}`;
}, true);

// ==== Bagaj yardÄ±mcÄ±larÄ± (Ã§akÄ±ÅŸmasÄ±z sÃ¼rÃ¼m) ====
(function(){
  // AynÄ± kod iki kez yÃ¼klenirse yeniden kurma.
  if (window.__bags_inited) return;
  window.__bags_inited = true;

  // const yerine korumalÄ± atama: iki kez tanÄ±mlansa bile sorun Ã§Ä±karmaz
  window.BAG_TRIP = window.BAG_TRIP || "{{ (trip['route'] ~ '|' ~ trip['plate'])|replace(' ', '_') }}";

  // FonksiyonlarÄ± da tek kez ata
  window.fetchBagCount = window.fetchBagCount || (async function fetchBagCount(seatNo){
    try{
      const u = `/bags?trip=${encodeURIComponent(window.BAG_TRIP)}&seat=${encodeURIComponent(seatNo)}&format=json`;
      const j = await safeJsonFetch(u);
      return Number(j?.count || 0);
    }catch(_){ return 0; }
  });

  window.refreshBagBadgeForSeat = window.refreshBagBadgeForSeat || (async function refreshBagBadgeForSeat(seatNo){
    const el = document.getElementById('seat-' + seatNo);
    if (!el) return;
    const cnt = await window.fetchBagCount(seatNo);
    el.classList.toggle('has-bag', cnt > 0);
    const bc = el.querySelector('.bag-badge .bag-count');
    if (bc) bc.textContent = String(cnt || 0);
  });

  window.refreshBagsAll = window.refreshBagsAll || (async function refreshBagsAll(){
    const seats = Array.from(document.querySelectorAll('.seat')).map(el => Number(el.dataset.seat));
    for (const n of seats) await window.refreshBagBadgeForSeat(n);
  });

  // Rozete tÄ±klayÄ±nca galeriye git (aynÄ± dinleyici bir kez eklensin)
  if (!window.__bag_click_bound){
    window.__bag_click_bound = true;
    document.addEventListener('click', (e)=>{
      const badge = e.target.closest('.bag-badge');
      if (!badge) return;
      e.stopPropagation(); e.preventDefault();
      const seatEl = badge.closest('.seat');
      const n = seatEl?.dataset.seat;
      if (!n) return;
      const back = location.pathname;
      location.href = `/bags?trip=${encodeURIComponent(window.BAG_TRIP)}&seat=${encodeURIComponent(n)}&next=${encodeURIComponent(back)}`;
    }, true);
  }
})();
</script>
{% endblock %}
